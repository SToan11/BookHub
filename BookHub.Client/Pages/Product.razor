@page "/"
@using BookHub.Client.Models
@inject BookHub.Client.Services.ProductsService ProductsService
@inject NavigationManager NavigationManager
@layout UserLayout

<div class="container mt-5">
    <div class="mb-4">
        <h3 class="h3 mb-4 text-dark">Danh sách sản phẩm</h3>

        <!-- Thanh tìm kiếm -->
        <div class="row g-3 align-items-center mb-4">
            <div class="col-md">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Tìm kiếm sản phẩm..."
                           @bind="searchTerm"
                           @bind:event="oninput"
                           @onkeyup="HandleSearch" />
                    <button class="btn btn-outline-secondary" @onclick="ClearSearch">
                        @if (!string.IsNullOrWhiteSpace(searchTerm))
                        {
                            <span class="fw-bold">✕</span>
                        }
                        else
                        {
                            <span>🔍</span>
                        }
                    </button>
                </div>
            </div>
            <div class="col-auto">
                <select class="form-select" @bind="selectedCategory">
                    <option value="">Tất cả thể loại</option>
                    @if (categories != null)
                    {
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    }
                </select>
            </div>
            <div class="col-auto">
                <select class="form-select" @bind="sortOption">
                    <option value="default">Sắp xếp mặc định</option>
                    <option value="price-asc">Giá: Thấp đến cao</option>
                    <option value="price-desc">Giá: Cao đến thấp</option>
                    <option value="name-asc">Tên: A-Z</option>
                </select>
            </div>
        </div>
    </div>

    @if (products == null)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 200px">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (filteredProducts.Count == 0)
    {
        <div class="alert alert-warning text-center">
            <p>Không tìm thấy sản phẩm nào phù hợp.</p>
            @if (!string.IsNullOrWhiteSpace(searchTerm) || !string.IsNullOrWhiteSpace(selectedCategory))
            {
                <button @onclick="ResetFilters" class="btn btn-link">Xóa bộ lọc</button>
            }
        </div>
    }
    else
    {
        <div class="mb-3 text-muted">
            Tìm thấy @filteredProducts.Count sản phẩm
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            @foreach (var product in filteredProducts)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="position-relative" @onclick="() => NavigateToProductDetail(product.Id)" style="cursor: pointer">
                            <img src="@(string.IsNullOrEmpty(product.Image) ? "/images/book-placeholder.png" : product.Image)"
                                 class="card-img-top" alt="@product.Name" style="height: 220px; object-fit: cover;">
                            @if (product.QuantityInStock < 5 && product.QuantityInStock > 0)
                            {
                                <span class="position-absolute top-0 end-0 badge bg-warning mt-2 me-2">Còn @product.QuantityInStock</span>
                            }
                            @if (product.QuantityInStock == 0)
                            {
                                <span class="position-absolute top-0 end-0 badge bg-danger mt-2 me-2">Hết hàng</span>
                            }
                        </div>
                        <div class="card-body" @onclick="() => NavigateToProductDetail(product.Id)" style="cursor: pointer">
                            <div class="mb-2">
                                @foreach (var category in product.Categories.Take(2))
                                {
                                    <span class="badge bg-primary me-1">@category</span>
                                }
                                @if (product.Categories.Count > 2)
                                {
                                    <span class="badge bg-secondary">+@(product.Categories.Count - 2)</span>
                                }
                            </div>
                            <h5 class="card-title">@product.Name</h5>
                            <p class="card-text text-muted">@product.Author</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary">@product.Price.ToString("N0") ₫</span>
                            <button class="btn btn-sm btn-primary" @onclick="() => AddToCart(product)" disabled="@(product.QuantityInStock == 0)">
                                Thêm vào giỏ
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (allProducts.Count > itemsPerPage)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    @for (int i = 0; i < Math.Ceiling((double)allProducts.Count / itemsPerPage); i++)
                    {
                        var pageNumber = i + 1;
                        <li class="page-item @(currentPage == pageNumber ? "active" : null)">
                            <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
</div>

@code {
    private List<ProductDto>? products;
    private List<ProductDto> allProducts = new List<ProductDto>();
    private List<ProductDto> filteredProducts = new List<ProductDto>();
    private List<string> categories = new List<string>();

    // Tìm kiếm và lọc
    private string searchTerm = "";
    private string selectedCategory = "";
    private string sortOption = "default";

    // Phân trang
    private int currentPage = 1;
    private int itemsPerPage = 12;

    protected override async Task OnInitializedAsync()
    {
        products = await ProductsService.GetAllProductsAsync();

        if (products != null)
        {
            allProducts = products;
            categories = allProducts
                .SelectMany(p => p.Categories)
                .Distinct()
                .OrderBy(c => c)
                .ToList();

            ApplyFilters();
        }
    }

    private void ApplyFilters()
    {
        filteredProducts = allProducts
            .Where(p =>
                (string.IsNullOrWhiteSpace(searchTerm) ||
                 p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                 p.Author.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrWhiteSpace(selectedCategory) ||
                 p.Categories.Contains(selectedCategory)))
            .ToList();

        filteredProducts = sortOption switch
        {
            "price-asc" => filteredProducts.OrderBy(p => p.Price).ToList(),
            "price-desc" => filteredProducts.OrderByDescending(p => p.Price).ToList(),
            "name-asc" => filteredProducts.OrderBy(p => p.Name).ToList(),
            _ => filteredProducts
        };

        filteredProducts = filteredProducts
            .Skip((currentPage - 1) * itemsPerPage)
            .Take(itemsPerPage)
            .ToList();
    }

    private void HandleSearch()
    {
        currentPage = 1;
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchTerm = "";
        HandleSearch();
    }

    private void ResetFilters()
    {
        searchTerm = "";
        selectedCategory = "";
        sortOption = "default";
        currentPage = 1;
        ApplyFilters();
    }

    private void ChangePage(int pageNumber)
    {
        currentPage = pageNumber;
        ApplyFilters();
    }

    private void NavigateToProductDetail(Guid productId)
    {
        NavigationManager.NavigateTo($"/products/{productId}");
    }

    private void AddToCart(ProductDto product)
    {
        Console.WriteLine($"Added {product.Name} to cart");
    }
}
